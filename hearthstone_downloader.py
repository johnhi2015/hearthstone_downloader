#!/usr/bin/env python3.4

'''
    cardRarity: {
        legendary: "传说",
        epic: "史诗",
        rare: "稀有",
        common: "普通",
        free: "基本"
    },
    cardClass: {
        neutral: "中立",
        druid: "德鲁伊",
        hunter: "猎人",
        mage: "法师",
        paladin: "圣骑士",
        priest: "牧师",
        rogue: "潜行者",
        shaman: "萨满",
        warlock: "术士",
        warrior: "战士"
    },
    cardType: {
        minion: "随从",
        spell: "法术",
        weapon: "武器"
    },
    cardRace: {
        murloc: "鱼人",
        demon: "恶魔",
        beast: "野兽",
        dragon: "龙",
        pirate: "海盗",
        mechs: "机械"
    },
    cardSet: {
        basic: "基本级",
        expert: "专家级",
        missions: "奖励",
        reward: "纪念",
        naxx: "纳克萨玛斯",
        gvg: "地精大战侏儒",
        brm: "黑石山的火焰"
    },
    cardEffect: {
        battlecry: "战吼",
        combo: "连击",
        divine_shield: "圣盾",
        overload: "过载",
        silence: "沉默",
        taunt: "嘲讽",
        spell_damage: "法术伤害",
        charge: "冲锋",
        death_rattle: "亡语",
        enrage: "激怒",
        secret: "奥秘",
        stealth: "潜行",
        windfury: "风怒",
        choice: "抉择"
    }
    
{
  "curPage": 1,
  "totalPage": 9,
  "cards": [
    {
      "name": "\u6708\u706b\u672f",
      "golden": 0,
      "id": 564,
      "code": "Moonfire",
      "background": "\u201c\u628a\u6708\u706b\u672f\u62d6\u5230\u6bcf\u4e00\u4e2a\u6280\u80fd\u680f\u4f4d\u4e0a\u3002\u201d\u2014\u2014\u300a\u5982\u4f55\u6210\u4e3a\u4e00\u540d\u5fb7\u9c81\u4f0a\u300b\uff0c\u7b2c\u4e94\u7ae0\uff0c\u7b2c\u4e09\u8282",
      "cardEffect": "",
      "cost": 0,
      "description": "\u9020\u62101\u70b9\u4f24\u5bb3\u3002",
      "cardRarity": "free",
      "cardClass": "druid",
      "cardSet": "basic",
      "cardType": "spell",
      "imageUrl": "http://hearthstone.nos.netease.com/1/cards/druid/Moonfire.png",
      "artist": "Richard Wright"
    },
    {
      "name": "\u6708\u706b\u672f",
      "golden": 1,
      "id": 3,
      "code": "Moonfire",
      "background": "\u201c\u628a\u6708\u706b\u672f\u62d6\u5230\u6bcf\u4e00\u4e2a\u6280\u80fd\u680f\u4f4d\u4e0a\u3002\u201d\u2014\u2014\u300a\u5982\u4f55\u6210\u4e3a\u4e00\u540d\u5fb7\u9c81\u4f0a\u300b\uff0c\u7b2c\u4e94\u7ae0\uff0c\u7b2c\u4e09\u8282",
      "cardEffect": "",
      "cost": 0,
      "description": "\u9020\u62101\u70b9\u4f24\u5bb3\u3002",
      "cardRarity": "free",
      "cardClass": "druid",
      "cardSet": "basic",
      "cardType": "spell",
      "imageUrl": "http://hearthstone.nos.netease.com/1/g-cards/druid/g-Moonfire.png",
      "artist": "Richard Wright"
    },
    {
      "name": "\u6fc0\u6d3b",
      "golden": 0,
      "id": 565,
      "code": "Innervate",
      "background": "\u6709\u4e9b\u5fb7\u9c81\u4f0a\u505a\u68a6\u7684\u65f6\u5019\u90fd\u4f1a\u88ab\u964c\u751f\u4eba\u7684\u201c\u7ed9\u6211\u4e2a\u6fc0\u6d3b\uff01\u201d\u7684\u558a\u53eb\u58f0\u60ca\u9192\u3002",
      "cardEffect": "",
      "cost": 0,
      "description": "\u4ec5\u5728\u672c\u56de\u5408\u4e2d\uff0c\u83b7\u5f972\u4e2a\u6cd5\u529b\u6c34\u6676\u3002",
      "cardRarity": "free",
      "cardClass": "druid",
      "cardSet": "basic",
      "cardType": "spell",
      "imageUrl": "http://hearthstone.nos.netease.com/1/cards/druid/Innervate.png",
      "artist": "Doug Alexander"
    },
    {
      "name": "\u6fc0\u6d3b",
      "golden": 1,
      "id": 1,
      "code": "Innervate",
      "background": "\u6709\u4e9b\u5fb7\u9c81\u4f0a\u505a\u68a6\u7684\u65f6\u5019\u90fd\u4f1a\u88ab\u964c\u751f\u4eba\u7684\u201c\u7ed9\u6211\u4e2a\u6fc0\u6d3b\uff01\u201d\u7684\u558a\u53eb\u58f0\u60ca\u9192\u3002",
      "cardEffect": "",
      "cost": 0,
      "description": "\u4ec5\u5728\u672c\u56de\u5408\u4e2d\uff0c\u83b7\u5f972\u4e2a\u6cd5\u529b\u6c34\u6676\u3002",
      "cardRarity": "free",
      "cardClass": "druid",
      "cardSet": "basic",
      "cardType": "spell",
      "imageUrl": "http://hearthstone.nos.netease.com/1/g-cards/druid/g-Innervate.png",
      "artist": "Doug Alexander"
    },
    {
      "name": "\u722a\u51fb",
      "golden": 0,
      "id": 590,
      "code": "Claw",
      "background": "\u662f\u53bb\u662f\u7559\uff0c\u8c01\u53bb\u8c01\u7559\uff0c\u90fd\u7531\u722a\u5b50\u51b3\u5b9a\u3002",
      "cardEffect": "",
      "cost": 1,
      "description": "\u4f7f\u4f60\u7684\u82f1\u96c4\u83b7\u5f972\u70b9\u62a4\u7532\u503c\uff0c\u5e76\u5728\u672c\u56de\u5408\u4e2d\u83b7\u5f97+2\u653b\u51fb\u529b\u3002",
      "cardRarity": "free",
      "cardClass": "druid",
      "cardSet": "basic",
      "cardType": "spell",
      "imageUrl": "http://hearthstone.nos.netease.com/1/cards/druid/Claw.png",
      "artist": "Dany Orizio"
    },
    {
      "name": "\u722a\u51fb",
      "golden": 1,
      "id": 4,
      "code": "Claw",
      "background": "\u662f\u53bb\u662f\u7559\uff0c\u8c01\u53bb\u8c01\u7559\uff0c\u90fd\u7531\u722a\u5b50\u51b3\u5b9a\u3002",
      "cardEffect": "",
      "cost": 1,
      "description": "\u4f7f\u4f60\u7684\u82f1\u96c4\u83b7\u5f972\u70b9\u62a4\u7532\u503c\uff0c\u5e76\u5728\u672c\u56de\u5408\u4e2d\u83b7\u5f97+2\u653b\u51fb\u529b\u3002",
      "cardRarity": "free",
      "cardClass": "druid",
      "cardSet": "basic",
      "cardType": "spell",
      "imageUrl": "http://hearthstone.nos.netease.com/1/g-cards/druid/g-Claw.png",
      "artist": "Dany Orizio"
    },
    {
      "gain": 5,
      "description": "\u6d88\u706d\u4e00\u4e2a\u968f\u4ece\uff0c\u4f60\u7684\u5bf9\u624b\u62bd\u4e24\u5f20\u724c\u3002",
      "golden": 0,
      "id": 2,
      "code": "Naturalize",
      "background": "\u4ed6\u4eec\u4e3a\u4ec0\u4e48\u8981\u5486\u54ee\uff1f\u6ca1\u4eba\u80fd\u591f\u786e\u5207\u5730\u4f5c\u51fa\u89e3\u91ca\u3002\u4e5f\u8bb8\u662f\u51fa\u4e8e\u5bf9\u5f53\u524d\u72b6\u6001\u4e0b\u4f53\u578b\u7684\u4e0d\u6ee1\uff1f\u4e5f\u8bb8\u5e76\u975e\u5982\u6b64\u3002",
      "cardEffect": "",
      "name": "\u81ea\u7136\u5e73\u8861",
      "cost": 1,
      "consume": 40,
      "cardRarity": "common",
      "cardClass": "druid",
      "cardSet": "expert",
      "cardType": "spell",
      "imageUrl": "http://hearthstone.nos.netease.com/1/cards/druid/Naturalize.png",
      "artist": "Leo Che"
    },
    {
      "gain": 50,
      "description": "\u6d88\u706d\u4e00\u4e2a\u968f\u4ece\uff0c\u4f60\u7684\u5bf9\u624b\u62bd\u4e24\u5f20\u724c\u3002",
      "golden": 1,
      "id": 7,
      "code": "Naturalize",
      "background": "\u4ed6\u4eec\u4e3a\u4ec0\u4e48\u8981\u5486\u54ee\uff1f\u6ca1\u4eba\u80fd\u591f\u786e\u5207\u5730\u4f5c\u51fa\u89e3\u91ca\u3002\u4e5f\u8bb8\u662f\u51fa\u4e8e\u5bf9\u5f53\u524d\u72b6\u6001\u4e0b\u4f53\u578b\u7684\u4e0d\u6ee1\uff1f\u4e5f\u8bb8\u5e76\u975e\u5982\u6b64\u3002",
      "cardEffect": "",
      "name": "\u81ea\u7136\u5e73\u8861",
      "cost": 1,
      "consume": 400,
      "cardRarity": "common",
      "cardClass": "druid",
      "cardSet": "expert",
      "cardType": "spell",
      "imageUrl": "http://hearthstone.nos.netease.com/1/g-cards/druid/g-Naturalize.png",
      "artist": "Leo Che"
    }
  ],
  "totalPerClass": {
    "warlock": 72,
    "neutral": 483,
    "hunter": 72,
    "paladin": 72,
    "priest": 72,
    "druid": 72,
    "warrior": 72,
    "rogue": 72,
    "shaman": 72,
    "mage": 72
  },
  "total": 72,
  "pageSize": 8,
  "curCardClass": "druid"
}
'''

import requests, math, json, os

_query_url = 'http://www.hearthstone.com.cn/cards/query'
_param1 = 'cardClass'
_param2 = 'p'

r = requests.get(_query_url)
rj = r.json()

#创建文件夹
dir = 'hearthstone'
if not os.path.exists(dir):
	print('创建文件夹     '+dir)
	os.mkdir(dir)

page_size = rj['pageSize']
for (key, value) in rj['totalPerClass'].items():
	count = 0
	print('\n\n\n开始处理     '+key)
	
	#创建文件夹
	dir = dir + r'/' + key
	if not os.path.exists(dir):
		print('创建文件夹     '+key)
		os.mkdir(dir)
		
	#配置页参数
	total = float(value)
	total = math.ceil(total / float(page_size))
	
	#获取json
	card_json_list = []
	for page in range(1, total+1):
		print('\n开始获取页数 ' + str(page) + r'/' + str(total))
		params = {}
		params[_param1]=key
		params[_param2]=page
		r = requests.get(_query_url, params=params)
		rj = r.json()
		
		card_list = rj['cards']
		
		#暂存当页字典
		card_json_list.extend(card_list)

		#下载图片
		for card in card_list:
			if card['golden'] == 1:
				img_url = card['imageUrl']
				img_dir = dir + r'/' + card['name'] + '-golden' + os.path.splitext(img_url)[1]
				if not os.path.exists(img_dir):
					count += 1
					print('(%d/%s)  下载图片: %s golden size' %(count, str(int(value)*2), card['name']))
					r = requests.get(img_url)
					with open(img_dir, 'wb') as file:
						file.write(r.content)
					
				img_url = img_url.replace(r'/g-cards/', r'/l-cards/g-cards/')
				img_dir = dir + r'/' + card['name'] + '-high-golden' + os.path.splitext(img_url)[1]
				if not os.path.exists(img_dir):
					count += 1
					print('(%d/%s)  下载图片: %s high golden size' %(count, str(int(value)*2), card['name']))
					r = requests.get(img_url)
					with open(img_dir, 'wb') as file:
						file.write(r.content)
			else:
				img_url = card['imageUrl']
				img_dir = dir + r'/' + card['name'] + os.path.splitext(img_url)[1]
				if not os.path.exists(img_dir):
					count += 1
					print('(%d/%s)  下载图片: %s normal size' %(count, str(int(value)*2), card['name']))
					r = requests.get(img_url)
					with open(img_dir, 'wb') as file:
						file.write(r.content)
				img_url = img_url.replace(r'/cards/', r'/l-cards/cards/')
				img_dir = dir + r'/' + card['name'] + '-high' + os.path.splitext(img_url)[1]
				if not os.path.exists(img_dir):
					count += 1
					print('(%d/%s)  下载图片: %s high size' %(count, str(int(value)*2), card['name']))
					r = requests.get(img_url)
					with open(img_dir, 'wb') as file:
						file.write(r.content)
			
	#保存字典
	json_str = json.dumps(card_json_list, indent=2)
	json_str_path = dir+'.json'
	if not os.path.exists(json_str_path):
		print('保存字典信息')
		with open(json_str_path, 'wb') as file:
			file.write(bytes(json_str, 'utf8'))	
			